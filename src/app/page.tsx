"use client"

import { useState, useEffect } from "react"
import { AppStep, ProfileData, SajuData, ChatMessage } from "@/types"
import { FACE_READING_KEYWORDS, SAJU_KEYWORDS, IDEAL_TYPE_KEYWORDS, dummyMatches } from "@/constants/data"

export default function FaceReadingApp() {
  const [currentStep, setCurrentStep] = useState<AppStep>("onboarding")
  const [uploadedImage, setUploadedImage] = useState<string | null>(null)
  const [additionalPhotos, setAdditionalPhotos] = useState<string[]>([])
  const [isAnalyzing, setIsAnalyzing] = useState(false)
  const [analysisProgress, setAnalysisProgress] = useState(3)
  const [faceReadingResults, setFaceReadingResults] = useState<Array<{ keyword: string; description: string }>>([])
  const [sajuResults, setSajuResults] = useState<Array<{ keyword: string; description: string }>>([])
  const [isSajuAnalyzing, setIsSajuAnalyzing] = useState(false)
  const [sajuProgress, setSajuProgress] = useState(3)

  const [integratedAnalysisStep, setIntegratedAnalysisStep] = useState<"photo" | "saju" | "analyzing" | "result">(
    "photo",
  )

  const [profileData, setProfileData] = useState<ProfileData>({
    nickname: "",
    gender: "",
    birthDate: "",
    birthTime: "",
    region: "",
    height: "",
    bodyType: "",
    job: "",
    education: "",
    school: "",
    introduction: "",
    idealKeywords: [],
  })
  const [sajuData, setSajuData] = useState<SajuData>({
    birthDate: "",
    birthTime: "",
    birthPlace: "",
    birthPlaceDetail: "",
  })
  const [sajuErrors, setSajuErrors] = useState<Record<string, string>>({})
  const [selectedIdealKeywords, setSelectedIdealKeywords] = useState<string[]>([])
  const [errors, setErrors] = useState<Record<string, string>>({})
  const [showMatches, setShowMatches] = useState(false)

  const [isEditingProfile, setIsEditingProfile] = useState(false)
  const [editProfileData, setEditProfileData] = useState(profileData)

  const [selectedUser, setSelectedUser] = useState<any>(null)

  const [messages, setMessages] = useState<ChatMessage[]>([])
  const [newMessage, setNewMessage] = useState("")

  const initializeChatMessages = (userName: string) => {
    const dummyMessages: ChatMessage[] = [
      {
        id: "1",
        text: "ÏïàÎÖïÌïòÏÑ∏Ïöî! ÌîÑÎ°úÌïÑÏùÑ Î≥¥Í≥† Ïó∞ÎùΩÎìúÎ†∏Ïñ¥Ïöî üòä",
        sender: "me",
        timestamp: new Date(Date.now() - 3600000), // 1ÏãúÍ∞Ñ Ï†Ñ
        isRead: true,
      },
      {
        id: "2",
        text: "ÏïàÎÖïÌïòÏÑ∏Ïöî! Í¥ÄÏÉÅ Í∂ÅÌï©Ïù¥ ÎÜíÎã§Í≥† ÎÇòÏôÄÏÑú Ïã†Í∏∞ÌñàÏñ¥Ïöî „Öé„Öé",
        sender: "other",
        timestamp: new Date(Date.now() - 3000000), // 50Î∂Ñ Ï†Ñ
        isRead: true,
      },
      {
        id: "3",
        text: "Ï†ÄÎèÑÏöî! Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Î≥¥Îãà Ï†ïÎßê Ïûò ÎßûÏùÑ Í≤É Í∞ôÎçîÎùºÍ≥†Ïöî. Ïñ¥Îñ§ Ïùº ÌïòÏÑ∏Ïöî?",
        sender: "me",
        timestamp: new Date(Date.now() - 2400000), // 40Î∂Ñ Ï†Ñ
        isRead: true,
      },
      {
        id: "4",
        text: `${userName === "ÍπÄÎØºÏ§Ä" ? "ÎîîÏûêÏù∏" : userName === "Ïù¥ÏÑúÏó∞" ? "ÎßàÏºÄÌåÖ" : "Í∞úÎ∞ú"} ÏùºÏùÑ ÌïòÍ≥† ÏûàÏñ¥Ïöî. ÌîÑÎ°úÌïÑÏóêÏÑú Î≥¥Îãà Í¥ÄÏÉÅÏù¥ Ï†ïÎßê Îî∞ÎúªÌï¥ Î≥¥Ïù¥ÏãúÎçîÎùºÍµ¨Ïöî!`,
        sender: "other",
        timestamp: new Date(Date.now() - 1800000), // 30Î∂Ñ Ï†Ñ
        isRead: true,
      },
      {
        id: "5",
        text: "Í∞êÏÇ¨Ìï¥Ïöî! ÏãúÍ∞Ñ ÎêòÏã§ Îïå Ïª§Ìîº Ìïú Ïûî Ïñ¥Îñ†ÏÑ∏Ïöî?",
        sender: "me",
        timestamp: new Date(Date.now() - 900000), // 15Î∂Ñ Ï†Ñ
        isRead: true,
      },
    ]
    setMessages(dummyMessages)
  }

  const sendMessage = () => {
    if (newMessage.trim()) {
      const message: ChatMessage = {
        id: Date.now().toString(),
        text: newMessage.trim(),
        sender: "me",
        timestamp: new Date(),
        isRead: false,
      }
      setMessages((prev) => [...prev, message])
      setNewMessage("")

      // ÏÉÅÎåÄÎ∞© ÏûêÎèô ÏùëÎãµ ÏãúÎÆ¨Î†àÏù¥ÏÖò
      setTimeout(() => {
        const responses = [
          "Ï¢ãÏïÑÏöî! Ïñ∏Ï†úÍ∞Ä Ï¢ãÏúºÏã§ÍπåÏöî?",
          "ÎÑ§, Ï¢ãÏùÄ ÏÉùÍ∞ÅÏù¥ÏóêÏöî üòä",
          "ÏãúÍ∞Ñ ÎßûÏ∂∞ÏÑú Ïó∞ÎùΩÎìúÎ¶¥Í≤åÏöî!",
          "Í∏∞ÎåÄÎêòÎÑ§Ïöî „Öé„Öé",
        ]
        const randomResponse = responses[Math.floor(Math.random() * responses.length)]
        const autoReply: ChatMessage = {
          id: (Date.now() + 1).toString(),
          text: randomResponse,
          sender: "other",
          timestamp: new Date(),
          isRead: false,
        }
        setMessages((prev) => [...prev, autoReply])
      }, 2000)
    }
  }

  const handlePhotoUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (file) {
      const reader = new FileReader()
      reader.onload = (e) => {
        setUploadedImage(e.target?.result as string)
        startAnalysis()
      }
      reader.readAsDataURL(file)
    }
  }

  const startAnalysis = () => {
    setIsAnalyzing(true)
    setAnalysisProgress(3)

    const timer = setInterval(() => {
      setAnalysisProgress((prev) => {
        if (prev <= 1) {
          clearInterval(timer)
          setIsAnalyzing(false)
          // ÎûúÎç§ Í¥ÄÏÉÅ ÌÇ§ÏõåÎìú 3-5Í∞ú ÏÉùÏÑ±
          const shuffled = [...FACE_READING_KEYWORDS].sort(() => 0.5 - Math.random())
          const selected = shuffled.slice(0, Math.floor(Math.random() * 3) + 3)
          setFaceReadingResults(selected)
          return 0
        }
        return prev - 1
      })
    }, 1000)
  }

  const startSajuAnalysis = () => {
    setIsSajuAnalyzing(true)
    setSajuProgress(3)

    const timer = setInterval(() => {
      setSajuProgress((prev) => {
        if (prev <= 1) {
          clearInterval(timer)
          setIsSajuAnalyzing(false)
          // ÎûúÎç§ ÏÇ¨Ï£º ÌÇ§ÏõåÎìú 3-5Í∞ú ÏÉùÏÑ±
          const shuffled = [...SAJU_KEYWORDS].sort(() => 0.5 - Math.random())
          const selected = shuffled.slice(0, Math.floor(Math.random() * 3) + 3)
          setSajuResults(selected)
          return 0
        }
        return prev - 1
      })
    }, 1000)
  }

  const handleInputChange = (field: string, value: any) => {
    setProfileData((prev) => ({ ...prev, [field]: value }))
    if (errors[field]) {
      setErrors((prev) => ({ ...prev, [field]: "" }))
    }
  }

  const handleSajuInputChange = (field: string, value: string) => {
    setSajuData((prev) => ({ ...prev, [field]: value }))
    if (sajuErrors[field]) {
      setSajuErrors((prev) => ({ ...prev, [field]: "" }))
    }
  }

  const validateProfile = () => {
    const newErrors: Record<string, string> = {}

    if (!profileData.nickname.trim()) newErrors.nickname = "ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
    if (!profileData.gender) newErrors.gender = "ÏÑ±Î≥ÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî"
    if (!profileData.birthDate) newErrors.birthDate = "ÏÉùÎÖÑÏõîÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
    if (!profileData.region) newErrors.region = "Í±∞Ï£º ÏßÄÏó≠ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî"
    if (!profileData.height) newErrors.height = "ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
    if (!profileData.bodyType) newErrors.bodyType = "Ï≤¥ÌòïÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî"
    if (!profileData.job.trim()) newErrors.job = "ÏßÅÏóÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
    if (!profileData.education) newErrors.education = "ÌïôÎ†•ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî"
    if (profileData.introduction.length > 1000) newErrors.introduction = "ÏûêÍ∏∞ÏÜåÍ∞úÎäî ÏµúÎåÄ 1000ÏûêÍπåÏßÄ ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§"

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const validateSajuData = () => {
    const newErrors: Record<string, string> = {}

    if (!sajuData.birthDate) newErrors.birthDate = "ÏÉùÎÖÑÏõîÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
    if (!sajuData.birthTime) newErrors.birthTime = "ÌÉúÏñ¥ÎÇú ÏãúÍ∞ÅÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
    if (!sajuData.birthPlace) newErrors.birthPlace = "ÌÉúÏñ¥ÎÇú ÏßÄÏó≠ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî"

    setSajuErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleIdealTypeToggle = (keyword: string) => {
    setSelectedIdealKeywords((prev) => {
      if (prev.includes(keyword)) {
        return prev.filter((k) => k !== keyword)
      } else if (prev.length < 3) {
        return [...prev, keyword]
      }
      return prev
    })
  }

  useEffect(() => {
    if (currentStep === "profile" && sajuData.birthDate && sajuData.birthTime) {
      setProfileData((prev) => ({
        ...prev,
        birthDate: sajuData.birthDate || prev.birthDate,
        birthTime: sajuData.birthTime || prev.birthTime,
      }))
    }
  }, [currentStep, sajuData.birthDate, sajuData.birthTime])

  const handleAdditionalPhotoUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files
    if (files) {
      const newPhotos: string[] = []
      Array.from(files).forEach((file) => {
        const reader = new FileReader()
        reader.onload = (e) => {
          const result = e.target?.result as string
          newPhotos.push(result)
          if (newPhotos.length === files.length) {
            setAdditionalPhotos((prev) => [...prev, ...newPhotos].slice(0, 5)) // ÏµúÎåÄ 5Ïû•ÍπåÏßÄ
          }
        }
        reader.readAsDataURL(file)
      })
    }
  }

  const removeAdditionalPhoto = (index: number) => {
    setAdditionalPhotos((prev) => prev.filter((_, i) => i !== index))
  }

  const handleEditProfileChange = (field: string, value: any) => {
    setEditProfileData((prev) => ({ ...prev, [field]: value }))
  }

  const saveProfileChanges = () => {
    setProfileData(editProfileData)
    setIsEditingProfile(false)
  }

  const cancelProfileEdit = () => {
    setEditProfileData(profileData)
    setIsEditingProfile(false)
  }

  if (currentStep === "onboarding") {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white flex flex-col items-center justify-center p-6">
        {/* Ïû•ÏãùÏ†Å Ìå®ÌÑ¥ */}
        <div className="absolute top-8 left-8 w-12 h-12 border-2 border-amber-400/30 border-dashed rounded-lg"></div>
        <div className="absolute top-8 right-8 w-12 h-12 border-2 border-amber-400/30 border-dashed rounded-lg"></div>
        <div className="absolute bottom-8 left-8 w-12 h-12 border-2 border-amber-400/30 border-dashed rounded-lg"></div>
        <div className="absolute bottom-8 right-8 w-12 h-12 border-2 border-amber-400/30 border-dashed rounded-lg"></div>

        {/* Î©îÏù∏ Ïª®ÌÖêÏ∏† */}
        <div className="text-center max-w-4xl mx-auto">
          {/* ÏÑúÎπÑÏä§ ÏÜåÍ∞ú Ïπ¥Îìú */}
          <div className="relative mb-12">
            <div className="flex items-center justify-center mb-8">
              {/* Î™®Î∞îÏùº Í∏∞Í∏∞ 1 */}
              <div className="relative transform -rotate-12 mr-8">
                <div className="w-64 h-96 bg-white rounded-3xl p-4 shadow-2xl">
                  <div className="w-full h-full bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-4 flex flex-col">
                    <div className="text-amber-400 text-lg font-bold mb-4">Í¥ÄÏÉÅ Î∂ÑÏÑù</div>
                    <div className="flex-1 flex flex-col justify-center space-y-3">
                      <div className="bg-amber-400/20 rounded-lg p-3">
                        <div className="text-amber-400 text-sm font-semibold">Îàà</div>
                        <div className="text-white text-xs">Îî∞ÎúªÌïòÍ≥† Í∞êÏÑ±Ï†Å</div>
                      </div>
                      <div className="bg-amber-400/20 rounded-lg p-3">
                        <div className="text-amber-400 text-sm font-semibold">ÏΩî</div>
                        <div className="text-white text-xs">ÏùòÏßÄÍ∞Ä Í∞ïÌï®</div>
                      </div>
                      <div className="bg-amber-400/20 rounded-lg p-3">
                        <div className="text-amber-400 text-sm font-semibold">ÏûÖ</div>
                        <div className="text-white text-xs">ÏÜåÌÜµ Îä•Î†• Ïö∞Ïàò</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Î™®Î∞îÏùº Í∏∞Í∏∞ 2 */}
              <div className="relative transform rotate-6">
                <div className="w-64 h-96 bg-white rounded-3xl p-4 shadow-2xl">
                  <div className="w-full h-full bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-4 flex flex-col">
                    <div className="text-amber-400 text-lg font-bold mb-4">ÏÇ¨Ï£º Î∂ÑÏÑù</div>
                    <div className="flex-1 flex flex-col justify-center items-center space-y-4">
                      <div className="w-32 h-32 rounded-full bg-gradient-to-br from-amber-400/30 to-amber-600/30 flex items-center justify-center">
                        <div className="text-amber-400 text-2xl">üåü</div>
                      </div>
                      <div className="text-center">
                        <div className="text-amber-400 font-semibold mb-2">Ïó∞Ïï†Ïö¥ ÏÉÅÏäπ</div>
                        <div className="text-white text-sm">Ïù¥ÏÉÅÏ†ÅÏù∏ ÎßåÎÇ® ÏòàÏ†ï</div>
                      </div>
                      <button className="bg-amber-400 text-black px-6 py-2 rounded-full text-sm font-semibold">
                        START
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* ÏÑúÎπÑÏä§ ÏÑ§Î™Ö ÌÖçÏä§Ìä∏ */}
            <div className="text-right">
              <h2 className="text-2xl font-bold text-white mb-2">Ïò§Î°úÏßÄ ÎãπÏã†ÎßåÏùÑ ÏúÑÌïú</h2>
              <h1 className="text-4xl font-bold text-amber-400 mb-4">ÏÑ∏ÏÉÅÏóê Îã® ÌïòÎÇòÎøêÏù∏ Í¥ÄÏÉÅ ÏÇ¨Ï£º Îß§Ïπ≠</h1>
              <h3 className="text-3xl font-bold text-amber-400">Í¥ÄÏÉÅÏùÄ Í≥ºÌïôÏù¥Îã§</h3>
            </div>
          </div>

          {/* ÏãúÏûë Î≤ÑÌäº */}
          <button
            onClick={() => setIntegratedAnalysisStep("photo")}
            className="bg-amber-400 hover:bg-amber-500 text-black px-12 py-4 rounded-full text-xl font-bold transition-colors shadow-lg"
          >
            Ïö¥Î™Ö Ï∞æÍ∏∞ ÏãúÏûë
          </button>
        </div>

        {/* Ï†êÏÑ† ÌÖåÎëêÎ¶¨ */}
        <div className="absolute inset-4 border-2 border-amber-400/20 border-dashed rounded-3xl pointer-events-none"></div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center">
      <h1>Í¥ÄÏÉÅÏùÄ Í≥ºÌïôÏù¥Îã§</h1>
    </div>
  )
}
